# キーポイント深度統合のノイズ処理分析

## 現在の深度統合の実装

### 1. 深度値の取得と補間

**実装場所**: `src/realsense_utils.py` - `_get_depth_with_interpolation()`

**処理フロー**:
1. **空間補間**: 周囲ピクセル（kernel_size=5）から深度値を取得
2. **外れ値除去**: IQR（四分位範囲）法を使用
   - Q1（25パーセンタイル）とQ3（75パーセンタイル）を計算
   - IQR = Q3 - Q1
   - 外れ値の閾値: `[Q1 - 1.5×IQR, Q3 + 1.5×IQR]` の範囲外を除去
3. **中央値の使用**: 外れ値除去後の深度値の中央値を使用（ノイズに対してロバスト）

**信頼度ベース適応的補間**:
- キーポイントの信頼度が0.5未満の場合、補間範囲を拡大（kernel_size + 2、最大7×7）

### 2. 3D座標への変換

**実装場所**: `src/realsense_utils.py` - `pixels_to_3d_batch()`

**処理**:
- カメラ内部パラメータ（intrinsics）を使用して2D座標と深度値から3D座標を計算
- 有効性チェック: 深度値がNoneまたは0以下の場合は無効として処理

## ノイズ処理の評価

### ✅ 適切に実装されている点

1. **空間補間**: 周囲ピクセルの中央値を使用することで、単一ピクセルのノイズを低減
2. **外れ値除去**: IQR法は統計的に標準的な手法
3. **中央値の使用**: 平均値よりも外れ値に対してロバスト
4. **信頼度ベース適応的補間**: 低信頼度のキーポイントに対してより広い範囲で補間

### ⚠️ 改善の余地がある点

1. **深度値の範囲チェック**: 現在は深度値が0より大きいことのみをチェック
   - **推奨**: 現実的な範囲（例: 0.3m～5.0m）をチェック
2. **深度値の一貫性チェック**: 周囲ピクセルとの深度差が大きすぎる場合の処理
   - **推奨**: 深度差が閾値（例: 0.5m）を超える場合は無効として処理
3. **複数フレームの統合**: 現在は単一フレームのみを使用
   - **推奨**: 複数フレームの深度値を統合してより安定した値を取得

## 論文としての前処理の妥当性

### 許容される前処理

1. **深度データの空間補間**: ✅ 標準的な手法
2. **外れ値除去（IQR法）**: ✅ 統計的に標準的な手法
3. **中央値の使用**: ✅ ノイズに対してロバストな手法

### 注意が必要な前処理

1. **Kalmanフィルタの適応的ノイズ調整**: ⚠️ パラメータを明示し、効果を検証する必要がある
2. **移動平均の重み付き平均（ウィンドウサイズ=10）**: ⚠️ パラメータを明示し、効果を検証する必要がある

## 推奨される改善

### 1. 深度値の範囲チェックを追加

```python
# 現実的な深度範囲をチェック
if depth_m < 0.3 or depth_m > 5.0:
    return None
```

### 2. 深度値の一貫性チェックを追加

```python
# 周囲ピクセルとの深度差をチェック
depth_diff = np.abs(valid_depths - depth_value)
if np.any(depth_diff > 0.5):  # 0.5m以上の差がある場合
    # より厳格な外れ値除去を適用
    pass
```

### 3. 前処理の段階的適用オプション

- **最小限の前処理**: 深度補間のみ（論文での比較用）
- **標準的な前処理**: 深度補間 + 外れ値除去（推奨）
- **高度な前処理**: 深度補間 + 外れ値除去 + 時系列平滑化（現在の実装）

## 結論

**深度統合のノイズ処理**: ✅ **適切に実装されている**

現在の実装は、深度データのノイズを適切に処理している。ただし、以下の改善を推奨：

1. **深度値の範囲チェック**: 現実的な範囲（0.3m～5.0m）をチェック
2. **深度値の一貫性チェック**: 周囲ピクセルとの深度差をチェック
3. **前処理の段階的適用**: 論文での比較実験のために、前処理を段階的に適用可能にする

**論文としての前処理**: ✅ **許容される範囲内**

ただし、以下の点に注意：
1. **前処理の明示**: すべての前処理とパラメータを明示する
2. **効果の検証**: 前処理の効果を定量的に評価する
3. **比較実験**: 前処理あり/なしの比較実験を実施する

