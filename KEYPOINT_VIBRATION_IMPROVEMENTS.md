# キーポイント振動の改善

## 問題点
キーポイントが目で見てわかるレベルで振動している。

## 実装した改善

### 1. Kalmanフィルタの適応的ノイズ調整（推奨度: ⭐⭐⭐⭐⭐）

**改善内容**:
- 観測値の変動を評価し、動的に観測ノイズを調整
- 外れ値の可能性が高い場合、観測ノイズを一時的に増やす（より滑らかに）
- 変動が小さい場合、観測ノイズを減らす（より反応を速く）

**実装**:
- `KalmanFilter3D`に`adaptive_noise`パラメータを追加
- イノベーション（観測値 - 予測値）の履歴を追跡
- 統計的手法（平均、標準偏差）を使用して外れ値を検出
- 外れ値の場合は観測ノイズを2倍に、正常な場合は0.8倍に調整

**効果**: 振動が大幅に減少（30-50%改善の可能性）

### 2. 移動平均の重み付き平均（推奨度: ⭐⭐⭐⭐）

**改善内容**:
- 通常の移動平均に加えて、重み付き平均を実装
- 中央のフレームに重みを付ける（線形重み）
- ガウシアン重み付き移動平均も実装

**実装**:
- `KeypointSmoother`に`use_weighted_average`パラメータを追加
- `_compute_linear_weights()`: 線形重みを計算（中央に重みを付ける）
- `_compute_gaussian_weights()`: ガウシアン重みを計算
- `_gaussian_weighted_average()`: ガウシアン重み付き移動平均を実装

**効果**: 振動が減少（20-30%改善の可能性）

### 3. デフォルトパラメータの最適化（推奨度: ⭐⭐⭐⭐⭐）

**改善内容**:
- 移動平均のウィンドウサイズ: 5 → **10**（より長い履歴で平滑化）
- 深度補間のカーネルサイズ: 3 → **5**（より広い範囲で補間）
- Kalmanフィルタの処理ノイズ: 0.03 → **0.005**（より滑らかに）
- Kalmanフィルタの測定ノイズ: 0.1 → **0.15**（より予測を信頼）

**効果**: 振動が大幅に減少（40-60%改善の可能性）

## 振動の原因

1. **姿勢推定モデルの誤差**: ViTPoseやYOLOv8-Poseの検出誤差
2. **深度データのノイズ**: RealSenseカメラの深度測定誤差
3. **キーポイントの信頼度**: 低信頼度のキーポイントが振動を引き起こす
4. **平滑化の不足**: 現在の平滑化設定が不十分

## 改善の効果

### 期待される改善
- **振動の減少**: 30-60%の改善
- **ジャンプ高さの精度向上**: 振動が減ることで、より正確な高さ計測が可能
- **視覚的な品質向上**: 可視化動画での振動が目立たなくなる

### 実装した改善の組み合わせ
1. **Kalmanフィルタ + 適応的ノイズ調整**: 最も効果的
2. **移動平均 + 重み付き平均**: 中程度の効果
3. **深度補間の改善**: 既に実装済み（IQR法による外れ値除去）

## 使用方法

### 推奨設定（振動を最小化）
```bash
python jump_analyzer.py --input input.bag --output results/ \
  --use-kalman-filter \
  --kalman-process-noise 0.005 \
  --kalman-measurement-noise 0.15 \
  --depth-kernel-size 5
```

### 設定ファイル（config.toml）
```toml
# キーポイントスムージング
smooth_keypoints = true
smooth_window_size = 10  # 振動を減らすため10に増加

# 深度データ処理
enable_depth_interpolation = true
depth_kernel_size = 5  # 振動を減らすため5に増加

# カルマンフィルタ（推奨）
use_kalman_filter = true
kalman_process_noise = 0.005  # 振動を減らすため0.005に減少
kalman_measurement_noise = 0.15  # 振動を減らすため0.15に増加
```

## 注意点

1. **平滑化が強すぎる場合**: ジャンプの動きが遅延する可能性がある
2. **パラメータの調整**: 個人の動きや環境に応じて調整が必要な場合がある
3. **処理速度**: より強力な平滑化は処理速度に影響する可能性がある

## 今後の改善案

1. **Savitzky-Golayフィルタ**: より高度な平滑化手法
2. **多段階平滑化**: 深度補間 → 時系列平滑化の2段階
3. **信頼度ベースの平滑化**: キーポイントの信頼度に応じて平滑化の強度を調整

