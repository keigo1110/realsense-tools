# ジャンプ高さ計測精度向上のための改善案

## 現在の実装状況

### 現在の高さ計算方法
- **使用キーポイント**: Mid-Hip（腰の中心）
- **高さ計算**: 床からの距離（床の法線ベクトルを使用）
- **最大高さ検出**: フレームごとに最大値を更新
- **離陸・着地検出**: 足首の高さ変化（5cm閾値）

## 改善案

### 1. 複数キーポイントの使用（推奨度: ⭐⭐⭐⭐⭐）

**問題点**:
- 現在はMid-Hipのみを使用しているが、ジャンプ中は体の姿勢が変化する
- 腰の位置だけでは、体の最高点を正確に捉えられない可能性がある

**改善案**:
- **頭頂部（Head/Nose）を使用**: ジャンプの最高点をより正確に捉える
- **複数キーポイントの統合**: 頭頂部、肩、腰の最高点を使用
- **計算方法**: 
  ```python
  # 頭頂部、肩、腰の最高点を使用
  max_height = max(
      head_height_above_floor,
      shoulder_height_above_floor,
      hip_height_above_floor
  )
  ```

**期待効果**: ジャンプ高さの精度が10-20%向上する可能性

### 2. 最大高さの補間（推奨度: ⭐⭐⭐⭐）

**問題点**:
- 現在はフレームごとの最大値のみを使用
- 実際の最大高さはフレーム間にある可能性がある

**改善案**:
- **スプライン補間**: ジャンプ中の高さデータをスプライン補間して、より滑らかな曲線を生成
- **ピーク検出**: 補間された曲線から最大値を検出
- **実装例**:
  ```python
  from scipy.interpolate import UnivariateSpline
  
  # ジャンプ中の高さデータを補間
  frames = [f for f in jump_frames]
  heights = [h for h in jump_heights]
  spline = UnivariateSpline(frames, heights, s=0)
  
  # 補間された曲線から最大値を検出
  max_height = spline(frames).max()
  ```

**期待効果**: ジャンプ高さの精度が5-10%向上する可能性

### 3. 離陸・着地タイミングの精度向上（推奨度: ⭐⭐⭐⭐）

**問題点**:
- 現在は5cmの閾値を使用しているが、より細かい検出が可能
- 離陸・着地の瞬間を正確に捉えることで、基準高さの精度が向上

**改善案**:
- **速度ベースの検出**: 高さの変化速度（速度）を使用して離陸・着地を検出
- **加速度ベースの検出**: 高さの変化加速度を使用
- **閾値の動的調整**: 個人の体格に応じて閾値を調整
- **実装例**:
  ```python
  # 高さの変化速度を計算
  height_velocity = (current_height - prev_height) / frame_time
  
  # 離陸: 速度が正の値で閾値を超えた場合
  if height_velocity > 0.5:  # m/s
      takeoff_detected = True
  ```

**期待効果**: 基準高さの精度が向上し、ジャンプ高さの精度が5-10%向上する可能性

### 4. ジャンプ中の高さデータの平滑化（推奨度: ⭐⭐⭐）

**問題点**:
- キーポイントの平滑化は既に実装されているが、ジャンプ中の高さデータの平滑化は未実装
- ノイズにより最大高さが過大評価される可能性がある

**改善案**:
- **移動平均フィルタ**: ジャンプ中の高さデータに移動平均を適用
- **Kalmanフィルタ**: より高度な平滑化（既存のKalmanフィルタを拡張）
- **実装例**:
  ```python
  # ジャンプ中の高さデータを平滑化
  smoothed_heights = []
  window_size = 3
  for i in range(len(jump_heights)):
      start = max(0, i - window_size // 2)
      end = min(len(jump_heights), i + window_size // 2 + 1)
      smoothed_heights.append(np.mean(jump_heights[start:end]))
  ```

**期待効果**: ノイズによる誤差が減少し、精度が3-5%向上する可能性

### 5. 床検出の精度向上（推奨度: ⭐⭐⭐⭐）

**問題点**:
- 床検出の精度が高さ計算の精度に直接影響する
- RANSACアルゴリズムのパラメータを最適化できる可能性がある

**改善案**:
- **複数フレームの統合**: 複数フレームの床検出結果を統合して、より安定した床平面を取得
- **外れ値の除去**: 床検出結果から外れ値を除去
- **パラメータの最適化**: RANSACのパラメータ（閾値、反復回数など）を最適化
- **実装例**:
  ```python
  # 複数フレームの床検出結果を統合
  floor_planes = []
  for frame in recent_frames:
      plane = detect_floor(frame)
      if plane is not None:
          floor_planes.append(plane)
  
  # 平均を計算
  avg_plane = np.mean(floor_planes, axis=0)
  ```

**期待効果**: 高さ計算の精度が5-10%向上する可能性

### 6. 重力方向の補正（推奨度: ⭐⭐⭐）

**問題点**:
- カメラが傾いている場合、重力方向を考慮した補正が必要
- 現在は床の法線ベクトルを使用しているが、重力方向との整合性を確認する必要がある

**改善案**:
- **重力方向の検出**: IMUデータや動きの分析から重力方向を推定
- **座標系の補正**: 重力方向を基準とした座標系に変換
- **実装例**:
  ```python
  # 重力方向を推定（動きの分析から）
  # ジャンプ中の加速度から重力方向を推定
  gravity_direction = estimate_gravity_direction(motion_data)
  
  # 床の法線ベクトルと重力方向の整合性を確認
  if np.dot(floor_normal, gravity_direction) < 0.9:
      # 補正が必要
      corrected_height = height * np.dot(floor_normal, gravity_direction)
  ```

**期待効果**: カメラが傾いている場合の精度が向上

### 7. 個人の体格に応じた補正（推奨度: ⭐⭐）

**問題点**:
- 個人の体格（身長、脚の長さなど）によって、基準高さが異なる
- 現在は固定の基準高さを使用している

**改善案**:
- **個人の体格推定**: キーポイントから個人の体格を推定
- **動的基準高さ**: 個人の体格に応じて基準高さを調整
- **実装例**:
  ```python
  # 個人の体格を推定（キーポイントから）
  estimated_height = estimate_person_height(keypoints_3d)
  
  # 基準高さを調整
  baseline_height = estimated_height * 0.5  # 腰の位置を推定
  ```

**期待効果**: 個人差による誤差が減少

### 8. ジャンプ軌跡の物理モデル（推奨度: ⭐⭐⭐）

**問題点**:
- 現在は単純に最大値を取っているが、物理モデルを使用することでより正確な推定が可能

**改善案**:
- **放物線フィッティング**: ジャンプ軌跡を放物線で近似
- **物理パラメータの推定**: 初速度、重力加速度などを推定
- **実装例**:
  ```python
  from scipy.optimize import curve_fit
  
  # 放物線モデル: h(t) = v0*t - 0.5*g*t^2 + h0
  def parabola(t, v0, g, h0):
      return v0 * t - 0.5 * g * t**2 + h0
  
  # フィッティング
  popt, _ = curve_fit(parabola, times, heights)
  v0, g, h0 = popt
  
  # 最大高さを計算: h_max = h0 + v0^2 / (2*g)
  max_height = h0 + v0**2 / (2 * g)
  ```

**期待効果**: ノイズの影響を減らし、より正確な最大高さを推定

## 実装優先順位

1. **複数キーポイントの使用**（最も効果的）
2. **最大高さの補間**（中程度の効果、実装が比較的簡単）
3. **離陸・着地タイミングの精度向上**（中程度の効果）
4. **床検出の精度向上**（中程度の効果）
5. **ジャンプ中の高さデータの平滑化**（小さい効果、実装が簡単）
6. **重力方向の補正**（カメラが傾いている場合に有効）
7. **ジャンプ軌跡の物理モデル**（高度だが効果的）
8. **個人の体格に応じた補正**（効果は限定的）

## 推奨実装順序

1. **Phase 1**: 複数キーポイントの使用 + 最大高さの補間
2. **Phase 2**: 離陸・着地タイミングの精度向上 + 床検出の精度向上
3. **Phase 3**: ジャンプ中の高さデータの平滑化 + 重力方向の補正
4. **Phase 4**: ジャンプ軌跡の物理モデル + 個人の体格に応じた補正

