# ジャンプ計測方法論

## 概要

本研究では、Intel RealSense深度カメラ（D455）とYOLOv8-Pose姿勢推定モデルを用いて、3次元空間におけるジャンプ動作の高精度計測を実現している。本ドキュメントでは、ジャンプ検出から各種測定値の算出方法まで、実験で使用した計測手法の詳細を記載する。

## システム構成

- **深度カメラ**: Intel RealSense D455
- **姿勢推定モデル**: YOLOv8-Pose (yolov8x-pose.pt)
- **床検出**: RANSACアルゴリズムによる平面検出（複数フレーム統合、外れ値除去、適応的閾値）
- **キーポイント平滑化**: 
  - 3次元空間でのKalmanフィルタ（等速運動モデル）
  - 深度値取得時の空間的メディアンフィルタ（外れ値除去付き）

## 座標系の定義

### RealSense座標系

- **X軸**: 左右方向（カメラから見て右が正）
- **Y軸**: 垂直方向（カメラから見て下が正）
- **Z軸**: 前後方向（カメラから見て奥が正、深度方向）

### 基準キーポイント

すべての高さ計測は**腰（Mid-Hip）**の位置を基準とする。
- Mid-Hipは左股関節（LHip）と右股関節（RHip）の中点として計算される
- 床検出が有効な場合、Mid-Hipから検出された床平面への垂直距離を使用

## 深度データの前処理

### 深度値の取得と補間

キーポイントの3D座標を計算するため、2Dキーポイント位置に対応する深度値を取得する。

**処理手順**:
1. **空間補間**: 各キーポイントの深度値を、周囲ピクセル（kernel_size=5×5）から取得
2. **外れ値除去**: IQR（四分位範囲）法を使用して外れ値を除去
   - Q1（25パーセンタイル）とQ3（75パーセンタイル）を計算
   - IQR = Q3 - Q1
   - 外れ値の閾値: `[Q1 - 1.5×IQR, Q3 + 1.5×IQR]` の範囲外を除去
3. **中央値の使用**: 外れ値除去後の深度値の中央値を使用（ノイズに対してロバスト）
4. **深度範囲チェック**: 現実的な深度範囲（0.3m～5.0m）をチェックし、範囲外の値を無効として処理

### 3D座標への変換

カメラ内部パラメータ（intrinsics）を使用して、2D画像座標と深度値から3Dカメラ座標を計算する。

**変換式**:
```
x_3d = (pixel_x - ppx) / fx * depth
y_3d = (pixel_y - ppy) / fy * depth
z_3d = depth
```

- `(pixel_x, pixel_y)`: 2D画像座標
- `depth`: 深度値（メートル）
- `(fx, fy)`: 焦点距離
- `(ppx, ppy)`: 主点座標

## 床検出

### 床平面の検出

RANSAC（Random Sample Consensus）アルゴリズムを使用して深度データから床平面を検出する。

- **サンプリング**: 深度画像を10ピクセル間隔でサンプリング（0.3m ～ 5.0mの範囲）
- **床判定閾値**: 3cm（平面からの距離が3cm以内の点をインライアとして判定）
- **反復回数**: 最大500回
- **安定化処理**: 過去20フレームの平面パラメータの加重移動平均を使用し、検出結果を安定化

### 床からの距離計算

任意の3D点 `(x, y, z)` から床平面までの垂直距離 $H_{floor}$ は、平面方程式 `ax + by + cz + d = 0` を用いて以下のように計算される：

$$
H_{floor} = \frac{|ax + by + cz + d|}{\sqrt{a^2 + b^2 + c^2}}
$$

## ジャンプ検出アルゴリズム

### 状態遷移モデル

ジャンプ検出は腰（Mid-Hip）の高さ変化に基づき、以下の4つの状態で管理される：

1. **Ground (接地)**: 静止状態または準備動作
2. **Takeoff (離陸)**: 足が離れる瞬間
3. **Airborne (空中)**: 滞空中
4. **Landing (着地)**: 再び接地した瞬間

### ゼロクロス検出法によるイベント判定

腰の高さの基準値（静止立位時の平均高さ）からの変位 $\Delta h$ を監視し、イベントを検出する。

1. **基準高さの初期化**: 
   - 検出開始時の最初の数フレームにおける腰の高さ（床からの距離）の平均値を基準高さ $h_{base}$ とする。

2. **離陸（Takeoff）検出**:
   - $\Delta h$ が負またはゼロから正に転じた時点（ゼロクロス点）を検出。
   - タイミング精度向上のため、前後フレームの値を用いて線形補間により正確なゼロクロス時刻を算出する。
   - 記録項目: `jump_takeoff_height`（離陸時の高さ）, `jump_takeoff_timestamp`

3. **着地（Landing）検出**:
   - 空中状態において、$\Delta h$ が正から負またはゼロに転じた時点を検出。
   - 同様に線形補間により正確な時刻を算出する。

## 測定値の定義と計算方法

### 1. ジャンプ高さ（Jump Height）

**定義**: 離陸時の腰の高さを基準とした、ジャンプ中の最大到達高さ。

**計算式**:
$$
H_{jump} = H_{max} - H_{takeoff}
$$

- $H_{max}$: 滞空中の最大腰高さ（床基準）
- $H_{takeoff}$: 離陸瞬間の腰高さ（床基準）

**単位**: メートル（m）またはセンチメートル（cm）

### 2. ジャンプ距離（Jump Distance）

**定義**: 離陸位置から着地位置までの水平移動距離。

**計算式**:
$$
D_{jump} = \sqrt{(x_{end} - x_{start})^2 + (z_{end} - z_{start})^2}
$$

- `(x, z)`: 水平面（XZ平面）上の座標
- Y軸（高さ方向）成分は含めない

### 3. 滞空時間（Air Time）

**定義**: 離陸から着地までの時間。

**計算式**:
$$
T_{air} = t_{end} - t_{takeoff}
$$

### 4. ジャンプの種類判定

水平移動距離に基づいてジャンプを分類する：

- **垂直ジャンプ（Vertical Jump）**: $D_{jump} < 10\text{cm}$
- **水平ジャンプ（Horizontal Jump）**: $D_{jump} \ge 10\text{cm}$

## 有効性フィルタリング

誤検出（ノイズや屈伸動作など）を除外するため、以下の最小閾値を設定している：

- **最小ジャンプ高さ**: 20cm
- **最小滞空時間**: 200ms

## データ出力

### CSVファイル

- **jump_statistics_jumps.csv**: 各ジャンプの詳細データ（高さ、距離、時間、初速、着地衝撃など）
- **jump_statistics_statistics.csv**: 全体統計データ（平均値、最大値など）

### 運動学的パラメータの推定

物理モデルに基づき以下のパラメータも推定して出力する：
- **初速 (Initial Velocity)**: 高さおよび滞空時間から算出
- **着地速度 (Landing Velocity)**: 自由落下モデルによる推定
- **着地衝撃 (Landing Impact)**: 減速時間（仮定値）に基づく加速度推定

## 検証方法

測定精度の検証には以下を推奨：
1. **手動測定との比較**: 既知の高さのボックスジャンプ等による絶対精度の検証
2. **再現性検証**: 同一動作の繰り返し測定によるばらつき（CV値）の評価
